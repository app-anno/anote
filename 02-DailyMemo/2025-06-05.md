---
created: 2025-05-31
tags:
---

## 習慣化リスト 
- HIITする
- HIIT終わったら、瞑想する
- 瞑想終わったら、筋トレする
- 記録 2@58
- 昼チャリこぐ 21@


## TODO
- 桐山さんとデータ欲しいものすり合わせる
- BigQuery Claude MCP サンプルスーパーストアをたらし込んでやってみたい

## 今週優先すること
1. ジョニーさんのKPI自動化
2. マップのリファクタ & パフォーマンス改善
3. 

## 今日優先すること
1. ~~くろさわさんに投げる~~
2. ~~EventBusのアップデート 確認する場所教える~~
3. 鳥取さんのクーポン割引額設定
	1. 確認中
4. ジョニーさん対応
5. サクセスチーム対応
6. 

## 小さな成功
- 
- 
- 

## 今日やったこと
- くろさわさんに投げる
- EventBusのアップデート 確認する場所教える
- 


## 自己省察

### 1日の振り返り
①今日の1日の行動や選択はどうだったか？
- 
- 
- 

②今日の過ごし方は自分はどういう風に感じたか？
- 
- 
- 

③うまくいったことはなにか？
- 
- 
- 

④失敗したことはなにか？
- 
- 
- 

## 学んだこと・気付き・その他・改善点
- GASのコード皆で共有するのいいな

## 明日すること
- 
- 
- 

## 明日へのアクション
- 
- 

## Memo
作業途中ブランチ
- migrate/native-base native-base一括変更チャレンジ途中
- fix/event-bus event-bus作業途中
- flow-migrate-ts ts移行途中
LT Memo
- ジェンガで家を建てる作業
- 爆弾処理班


ここまでできた！

CREATE OR REPLACE TABLE `data-infrastructure-456304`.`intermediate_table`.`daily_ga4_reservation_analysis` AS

WITH base_config AS (
  SELECT
    DATE('2025-04-01') AS start_date,
    CURRENT_DATE() AS end_date
),

-- 日付マスタ生成（2025-04以降の全日付）
date_master AS (
  SELECT date_value
  FROM UNNEST(GENERATE_DATE_ARRAY(
    (SELECT start_date FROM base_config),
    (SELECT end_date FROM base_config),
    INTERVAL 1 DAY
  )) AS date_value
),

-- 店舗カテゴリデータ（時点での変化に対応）- ship_categoryテーブル使用
ship_category_data AS (
  SELECT 
    shipid,
    ships_name,
    success_manager_name,
    p_store,
    analysis_date,
    fee_free_end_date,
    is_in_free_period,
    store_category,
    judgment_detail,
    is_p_store,
    is_new_store,
    is_existing_store,
    updated_at
  FROM `data-infrastructure-456304.ship_hubspot_data.ship_category`
),

-- 各船舗の最初の店舗カテゴリを特定（過去遡及用）
ship_first_category AS (
  SELECT
    shipid,
    FIRST_VALUE(store_category) OVER (
      PARTITION BY shipid 
      ORDER BY COALESCE(analysis_date, DATE('1900-01-01')), updated_at
    ) AS first_store_category
  FROM ship_category_data
  QUALIFY ROW_NUMBER() OVER (PARTITION BY shipid ORDER BY COALESCE(analysis_date, DATE('1900-01-01')), updated_at) = 1
),

-- 日付別の最新店舗カテゴリを事前計算（過去遡及ロジック追加）
ship_category_by_date AS (
  SELECT
    dm.date_value AS target_date,
    COALESCE(sc.shipid, sfc.shipid) AS shipid,
    COALESCE(sc.store_category, sfc.first_store_category) AS store_category,
    sc.analysis_date,
    sc.updated_at
  FROM date_master dm
  CROSS JOIN ship_first_category sfc
  LEFT JOIN ship_category_data sc
    ON sfc.shipid = sc.shipid
    AND (sc.analysis_date IS NULL OR sc.analysis_date <= dm.date_value)
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY dm.date_value, COALESCE(sc.shipid, sfc.shipid)
    ORDER BY COALESCE(sc.analysis_date, DATE('1900-01-01')) DESC, COALESCE(sc.updated_at, DATETIME('1900-01-01')) DESC
  ) = 1
),

-- 釣船マスタ（ship_categoryテーブルと結合して店舗カテゴリを決定）
ship_category_mapping AS (
  SELECT 
    s.id AS ship_id,
    s.name AS ship_name,
    s.created_at AS ship_created_at,
    sc.ships_name AS category_ship_name,
    sc.analysis_date,
    sc.store_category,
    sc.is_p_store,
    sc.is_new_store,
    sc.is_existing_store,
    sc.updated_at AS category_updated_at
  FROM `data-infrastructure-456304.ds_prod_anglers_db_next.ships` s
  LEFT JOIN ship_category_data sc
    ON s.id = sc.shipid
  WHERE s.deleted_at IS NULL
  -- 最新のカテゴリレコードを取得
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY s.id 
    ORDER BY COALESCE(sc.analysis_date, DATE('1900-01-01')) DESC, COALESCE(sc.updated_at, DATETIME('1900-01-01')) DESC
  ) = 1
),

-- GA4データ抽出（全ユーザーベース - user_pseudo_id使用）
ship_level_data AS (
  SELECT
    PARSE_DATE('%Y%m%d', event_date) AS date,
    user_pseudo_id,  -- :arrows_counterclockwise: 全ユーザー（未ログイン含む）集計用
    (SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') AS ga_session_id,
    (SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'page_location') AS page_location,
    traffic_source.source,
    traffic_source.medium,
    event_name
  FROM `ships-425309.analytics_427925836.events_*`, base_config
  WHERE
    PARSE_DATE('%Y%m%d', event_date) BETWEEN base_config.start_date AND base_config.end_date
    AND event_name = 'page_view'
    AND (SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'page_location') LIKE 'https://ships.anglers.jp%'
),

-- GA4分類処理（ShipIDを抽出）
classified_data AS (
  SELECT
    *,
    CASE
      WHEN REGEXP_CONTAINS(page_location, '/ships/[0-9]+') THEN
        CAST(REGEXP_EXTRACT(page_location, '/ships/([0-9]+)') AS INT64)
      ELSE NULL
    END AS ShipID,
    CASE
      WHEN source IS NULL OR (source = "(direct)" AND medium = "(none)") THEN 'ダイレクト'
      WHEN source = "line" THEN 'LINE'
      WHEN medium = "organic" THEN 'オーガニック'
      WHEN source = "anglers" AND (medium LIKE "%web%" OR medium = "lp") THEN 'アングラーズWEB'
      WHEN (source IN ("anglers", "app", "notice") OR medium = "anglers_app")
           AND NOT (medium LIKE "%web%" OR medium = "lp") THEN 'アングラーズアプリ'
      WHEN REGEXP_CONTAINS(source, 'sns|twitter|facebook|insta|youtube|x')
           OR REGEXP_CONTAINS(medium, 'sns|twitter|facebook|insta') THEN 'SNS'
      WHEN (source = "google" AND medium IN ("cpc", "ppc", "pmax", "p-max"))
           OR (source = "adwords" AND medium = "ppc")
           OR (source = "meta" AND medium = "cv") THEN '広告'
      ELSE 'その他'
    END AS source_genre,
    -- :arrows_counterclockwise: 4分類セグメント（variation追加）
    CASE
      WHEN REGEXP_CONTAINS(page_location, '/ships/[^/]+/plans.*/variations') THEN 'variation'
      WHEN REGEXP_CONTAINS(page_location, '/ships/[^/]+/plans') THEN 'plan'
      WHEN REGEXP_CONTAINS(page_location, '/ships/') THEN 'ship'
      ELSE 'other'
    END AS segment
  FROM ship_level_data
  WHERE page_location IS NOT NULL
),

-- 船カテゴリ結合（ship_categoryテーブルベースの結合結果を使用）
enriched_data AS (
  SELECT
    cd.*,
    COALESCE(scm.store_category, 'その他') AS store_category
  FROM classified_data cd
  LEFT JOIN ship_category_mapping scm
    ON cd.ShipID = scm.ship_id
),

-- GA4日別基本集計（user_pseudo_idベース）
ga4_daily_metrics AS (
  SELECT
    date,
    store_category,
    source_genre,
    COUNT(DISTINCT user_pseudo_id) AS ship_page_mau,  -- :arrows_counterclockwise: 全ユーザーベースMAU
    COUNT(DISTINCT CASE WHEN segment IN ('plan', 'variation') THEN user_pseudo_id END) AS plan_page_mau,  -- :arrows_counterclockwise: 4分類対応
    COUNT(DISTINCT CONCAT(user_pseudo_id, '_', CAST(COALESCE(ga_session_id, 0) AS STRING))) AS session_count,
    COUNTIF(event_name = 'page_view') AS page_views
  FROM enriched_data
  GROUP BY date, store_category, source_genre
),

-- GA4日別店舗カテゴリ集計
ga4_daily_store_totals AS (
  SELECT
    date,
    store_category,
    SUM(ship_page_mau) AS total_ship_mau,
    SUM(plan_page_mau) AS total_plan_mau,
    SUM(session_count) AS total_sessions,
    SUM(page_views) AS total_page_views,
    SUM(CASE WHEN source_genre = 'オーガニック' THEN session_count ELSE 0 END) AS organic_sessions,
    SUM(CASE WHEN source_genre = 'アングラーズアプリ' THEN session_count ELSE 0 END) AS anglers_app_sessions,
    SUM(CASE WHEN source_genre = '広告' THEN session_count ELSE 0 END) AS ad_sessions,
    SUM(CASE WHEN source_genre = 'SNS' THEN session_count ELSE 0 END) AS sns_sessions,
    SUM(CASE WHEN source_genre = 'ダイレクト' THEN session_count ELSE 0 END) AS direct_sessions,
    SUM(CASE WHEN source_genre = 'アングラーズWEB' THEN session_count ELSE 0 END) AS anglers_web_sessions
  FROM ga4_daily_metrics
  GROUP BY date, store_category
),

-- GA4日別全体集計（重複除去）
ga4_daily_all_totals AS (
  SELECT
    date,
    COUNT(DISTINCT CASE WHEN segment IN ('plan', 'variation') THEN user_pseudo_id END) AS all_plan_mau  -- :arrows_counterclockwise: 4分類対応
  FROM enriched_data
  GROUP BY date
),

-- 予約データ（過去全期間の新規/既存判定用）
all_reservations AS (
  SELECT
    sr.id,
    sr.account_id,
    sr.ship_id,
    DATE(sr.created_at) AS reservation_date,
    sr.participants,
    sr.list_price,
    sr.options_price,
    sr.discount_price,
    ROW_NUMBER() OVER (PARTITION BY sr.account_id ORDER BY sr.created_at) AS reservation_order
  FROM `data-infrastructure-456304.ds_prod_anglers_db_next.ship_reservations` sr
  WHERE sr.inflow_source = 0
    AND sr.kana NOT LIKE '%レクチャー%'
),

-- 割引設定（クーポン以外）
discount_without_coupons AS (
  SELECT
    srdp.ship_reservation_id,
    SUM(srdp.discount_price * srdp.participants) AS discount_price_without_coupons
  FROM `data-infrastructure-456304.ds_prod_anglers_db_next.ship_reservation_discount_prices` srdp
  WHERE srdp.deleted_at IS NULL
  GROUP BY srdp.ship_reservation_id
),

-- クーポン使用データ
coupon_usage AS (
  SELECT
    src.ship_reservation_id,
    SUM(src.discount_price) AS coupon_discount_total
  FROM `data-infrastructure-456304.ds_prod_anglers_db_next.ship_reservation_coupons` src
  WHERE src.deleted_at IS NULL
  GROUP BY src.ship_reservation_id
),

-- 対象期間の予約データ（ship_categoryテーブルベースの結合結果を使用）
target_reservations AS (
  SELECT
    ar.*,
    COALESCE(scm.store_category, 'その他') AS store_category,
    ar.list_price + COALESCE(ar.options_price, 0) - COALESCE(dwc.discount_price_without_coupons, 0) AS all_send_gmv,
    cu.coupon_discount_total,
    CASE WHEN cu.ship_reservation_id IS NOT NULL THEN 1 ELSE 0 END AS has_coupon
  FROM all_reservations ar, base_config
  LEFT JOIN ship_category_mapping scm
    ON ar.ship_id = scm.ship_id
  LEFT JOIN discount_without_coupons dwc
    ON ar.id = dwc.ship_reservation_id
  LEFT JOIN coupon_usage cu
    ON ar.id = cu.ship_reservation_id
  WHERE ar.reservation_date BETWEEN base_config.start_date AND base_config.end_date
),

-- 予約日別集計
reservation_daily_metrics AS (
  SELECT
    reservation_date AS date,
    store_category,
    COUNT(*) AS reservation_count,
    SUM(all_send_gmv) AS total_reservation_amount,
    SUM(participants) AS total_participants,
    ROUND(AVG(participants), 2) AS avg_participants_per_reservation,
    COUNT(DISTINCT account_id) AS reservation_uu,
    COUNT(DISTINCT CASE WHEN reservation_order = 1 THEN account_id END) AS new_reservation_uu,
    COUNT(DISTINCT CASE WHEN reservation_order > 1 THEN account_id END) AS existing_reservation_uu,
    SUM(all_send_gmv) AS gmv,
    SUM(has_coupon) AS coupon_reservation_count,
    SUM(COALESCE(coupon_discount_total, 0)) AS coupon_total_amount
  FROM target_reservations
  GROUP BY reservation_date, store_category
),

-- 予約全体集計（日別、全店舗を含む）
reservation_daily_all_totals AS (
  SELECT
    reservation_date AS date,
    SUM(all_send_gmv) AS all_total_reservation_amount,
    COUNT(*) AS all_reservation_count,
    SUM(participants) AS all_total_participants,
    ROUND(AVG(participants), 2) AS all_avg_participants_per_reservation
  FROM target_reservations
  GROUP BY reservation_date
),

-- 店舗カテゴリのマスタ
store_categories AS (
  SELECT 'P店舗' AS store_category
  UNION ALL SELECT '既存店舗'
  UNION ALL SELECT '新規店舗'
  UNION ALL SELECT 'その他'
),

-- 店舗数累計計算（完全JOINベース - ship_categoryテーブル使用）
-- 1. 各船舗の日付別カテゴリデータ
ship_daily_categories AS (
  SELECT 
    s.id AS ship_id,
    DATE(s.created_at) AS ship_created_date,
    dm.date_value AS target_date,
    COALESCE(scbd.store_category, 'その他') AS store_category
  FROM `data-infrastructure-456304.ds_prod_anglers_db_next.ships` s
  CROSS JOIN date_master dm
  LEFT JOIN ship_category_by_date scbd
    ON s.id = scbd.shipid AND scbd.target_date = dm.date_value
  WHERE s.deleted_at IS NULL
    AND DATE(s.created_at) <= dm.date_value
),

-- 2. 日付別・カテゴリ別店舗数集計
store_count_by_category AS (
  SELECT
    target_date AS date,
    store_category,
    COUNT(DISTINCT ship_id) AS store_count
  FROM ship_daily_categories
  GROUP BY target_date, store_category
),

-- 3. 全店舗数（カテゴリ関係なし）
all_store_count_daily AS (
  SELECT
    dm.date_value AS date,
    COUNT(DISTINCT s.id) AS all_store_count
  FROM date_master dm
  LEFT JOIN `data-infrastructure-456304.ds_prod_anglers_db_next.ships` s
    ON DATE(s.created_at) <= dm.date_value
    AND s.deleted_at IS NULL
  GROUP BY dm.date_value
),

-- 4. 店舗数累計（JOINベース）
store_count_cumulative AS (
  SELECT
    dm.date_value AS date,
    COALESCE(p_stores.store_count, 0) AS p_store_count_cumulative,
    COALESCE(existing_stores.store_count, 0) AS existing_store_count_cumulative,
    COALESCE(new_stores.store_count, 0) AS new_store_count_cumulative,
    COALESCE(other_stores.store_count, 0) AS other_store_count_cumulative,
    COALESCE(ascd.all_store_count, 0) AS all_store_count_cumulative
  FROM date_master dm
  LEFT JOIN store_count_by_category p_stores
    ON dm.date_value = p_stores.date AND p_stores.store_category = 'P店舗'
  LEFT JOIN store_count_by_category existing_stores
    ON dm.date_value = existing_stores.date AND existing_stores.store_category = '既存店舗'
  LEFT JOIN store_count_by_category new_stores
    ON dm.date_value = new_stores.date AND new_stores.store_category = '新規店舗'
  LEFT JOIN store_count_by_category other_stores
    ON dm.date_value = other_stores.date AND other_stores.store_category = 'その他'
  LEFT JOIN all_store_count_daily ascd
    ON dm.date_value = ascd.date
),

-- 日付×店舗カテゴリのフルマトリックス
date_store_matrix AS (
  SELECT
    dm.date_value AS date,
    sc.store_category
  FROM date_master dm
  CROSS JOIN store_categories sc
)

-- 最終結果
SELECT
  dsm.date,
  dsm.store_category,
  
  -- 店舗数累計
  CASE 
    WHEN dsm.store_category = 'P店舗' THEN scc.p_store_count_cumulative
    WHEN dsm.store_category = '既存店舗' THEN scc.existing_store_count_cumulative  
    WHEN dsm.store_category = '新規店舗' THEN scc.new_store_count_cumulative
    WHEN dsm.store_category = 'その他' THEN scc.other_store_count_cumulative
    ELSE 0
  END AS store_count_cumulative,
  
  scc.all_store_count_cumulative AS all_store_count_cumulative,
  
  -- GA4指標（全ユーザーベース）
  COALESCE(gdst.organic_sessions, 0) AS organic_sessions,
  COALESCE(gdst.anglers_app_sessions, 0) AS anglers_app_sessions,
  COALESCE(gdst.ad_sessions, 0) AS ad_sessions,
  COALESCE(gdst.sns_sessions, 0) AS sns_sessions,
  COALESCE(gdst.direct_sessions, 0) AS direct_sessions,
  COALESCE(gdst.anglers_web_sessions, 0) AS anglers_web_sessions,
  COALESCE(gdst.total_sessions, 0) AS total_sessions,
  COALESCE(gdst.total_ship_mau, 0) AS ship_page_mau,
  COALESCE(gdst.total_plan_mau, 0) AS plan_page_mau,
  COALESCE(gdst.total_page_views, 0) AS total_page_views,
  
  -- 予約指標
  COALESCE(rdm.reservation_count, 0) AS reservation_count,
  COALESCE(rdm.total_reservation_amount, 0) AS total_reservation_amount,
  COALESCE(rdm.total_participants, 0) AS total_participants,
  COALESCE(rdm.avg_participants_per_reservation, 0) AS avg_participants_per_reservation,
  COALESCE(rdm.reservation_uu, 0) AS reservation_uu,
  COALESCE(rdm.new_reservation_uu, 0) AS new_reservation_uu,
  COALESCE(rdm.existing_reservation_uu, 0) AS existing_reservation_uu,
  COALESCE(rdm.gmv, 0) AS gmv,
  COALESCE(rdm.coupon_reservation_count, 0) AS coupon_reservation_count,
  COALESCE(rdm.coupon_total_amount, 0) AS coupon_total_amount,
  
  -- 全体指標
  COALESCE(gdat.all_plan_mau, 0) AS all_plan_mau_unique,
  COALESCE(rdat.all_total_reservation_amount, 0) AS all_total_reservation_amount,
  COALESCE(rdat.all_reservation_count, 0) AS all_reservation_count,
  COALESCE(rdat.all_total_participants, 0) AS all_total_participants,
  COALESCE(rdat.all_avg_participants_per_reservation, 0) AS all_avg_participants_per_reservation

FROM date_store_matrix dsm
LEFT JOIN ga4_daily_store_totals gdst
  ON dsm.date = gdst.date
  AND dsm.store_category = gdst.store_category
LEFT JOIN reservation_daily_metrics rdm
  ON dsm.date = rdm.date
  AND dsm.store_category = rdm.store_category
LEFT JOIN ga4_daily_all_totals gdat
  ON dsm.date = gdat.date
LEFT JOIN reservation_daily_all_totals rdat
  ON dsm.date = rdat.date
LEFT JOIN store_count_cumulative scc
  ON dsm.date = scc.date

ORDER BY dsm.date, dsm.store_category;

